<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api/TelegramApi.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: api/TelegramApi.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const req = require('tiny_request')
const CallbackQueue = require('../utils/CallbackQueue')
const TelegramApiRequest = require('./TelegramApiRequest')
const Models = require('../models/Models')
const Message = require('../models/Message')
const File = require('../models/File')
const UserProfilePhotos = require('../models/UserProfilePhotos')
const User = require('../models/User')
const Update = require('../models/Update')
const Chat = require('../models/Chat')
const ChatMember = require('../models/ChatMember')
const InputFile = require('./InputFile')
const TelegramApiError = require('./TelegramApiError')
const GameHighScore = require('../models/GameHighScore')

const REQUESTS_PER_SECOND = 30
const REQUEST_RETRY_TIMEOUT = 1000 //ms

/**
 * Telegram API class
 */
class TelegramApi {
    /**
     *
     * @param {string} token
     * @param {BaseLogger} logger
     */
    constructor(token, logger) {
        this._token = token
        this._url = `https://api.telegram.org/bot${this._token}/`
        this._queue = new CallbackQueue(REQUESTS_PER_SECOND)
        this._logger = logger
    }

    /**
     *
     * @param {string} method
     * @returns {string}
     * @private
     */
    _urlForMethod(method) {
        return this._url + method
    }

    /**
     * 
     * @param {string} method
     * @param {object} params
     * @param {object} [multipart]
     * @returns {Promise&lt;Object>}
     */
    call(method, params, multipart) {
        return new Promise((resolve, reject) => {
            const request = new TelegramApiRequest(method, params, multipart)

            this._queue.push(() => {
                this._handleRequest(request, resolve, reject)
            })
        })
    }

    /**
     *
     * @param {string} method
     * @param {Object} params
     * @param {function} type
     * @param {object} [multipart]
     * @returns {Promise}
     * @private
     */
    _callWithReturnType(method, params, type, multipart) {
        return this.call(method, params, multipart)
            .then(response => {
                return type.deserialize(response.result)
            })
    }

    /**
     *
     * @param {TelegramApiRequest }request
     * @param {function} resolve
     * @param {function} reject
     * @private
     */
    _handleRequest(request, resolve, reject) {
        req.post({
            url: this._urlForMethod(request.method),
            form: request.multipart ? null : request.params,
            query: request.multipart ? request.params : null,
            multipart: request.multipart,
            json: true
        }, (body, response, err) => {
            if (!err &amp;&amp; response.statusCode == 200 &amp;&amp; body) {
                resolve(body)
                return
            }

            if (err &amp;&amp; err.code) {
                this._logger.error({'Network error:': err, 'request': request })
                this._retryRequest(request, resolve, reject)

                return
            }

            if (body &amp;&amp; body.error_code) {
                const error = TelegramApiError.fromResponse(body)

                if (error.code == 500) {
                    this._logger.warn({ 'Got Internal server error from Telegram. Body:': body })
                    this._retryRequest(request, resolve, reject)

                    return
                }

                reject(error)
                this._logger.warn({ 'Api error: Body:': body })

                return
            }

            if (err.message === 'Unexpected token &lt; in JSON at position 0') {
                this._logger.error({
                    'api request error: Telegram returned some html instead of json. Body:': body,
                    'Error:': err
                })
                this._retryRequest(request, resolve, reject)

                return
            }

            this._logger.error({'api request error: Body:': body, 'Error:': err })
            reject(err)
        })
    }

    /**
     *
     * @param {TelegramApiRequest }request
     * @param {function} resolve
     * @param {function} reject
     * @private
     */
    _retryRequest(request, resolve, reject) {
        setTimeout(() => {
            this._queue.push(() => {
                this._logger.log({ 'Retry request': request })
                this._handleRequest(request, resolve, reject)
            })
        }, REQUEST_RETRY_TIMEOUT)
    }

    /**
     *
     * @param {string} method
     * @param {InputFile|Object} inputFile
     * @param {string} type
     * @param {Object} params
     * @returns {Promise}
     * @private
     */
    _callWithInputFile(method, inputFile, type, params) {
        const file = inputFile instanceof InputFile ? inputFile : InputFile.deserialize(inputFile)
        let sentCallback = Function()

        return file.prepareRequest(type, params)
            .then(prepared =>  {
                sentCallback = prepared.callback || Function()
                
                return this._callWithReturnType(
                    method,
                    prepared.params,
                    Message,
                    prepared.multipart
                )
            })
            .then(r => {
                sentCallback()
                
                return r
            })
    }

    /**
     *
     * @param {Object} [options]
     * @returns {Promise&lt;Update[]>}
     */
    getUpdates(options) {
        return this.call('getUpdates', options)
            .then(r => r.result.map(u => Update.deserialize(u)))
    }

    /**
     *
     * @param options
     * @returns {Promise&lt;Object>}
     */
    setWebhook(options) {
        return this._callWithReturnType('setWebhook', {
            url: options.url ? options.url + '/' + this._token : ''
        }, Models.Update)
    }

    /**
     *
     * @returns {Promise&lt;User>}
     */
    getMe() {
        return this._callWithReturnType('getMe', {}, User)
    }

    /**
     *
     * @param {number|string} chatId
     * @param {string} text
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendMessage(chatId, text, options) {
        const params = {
            chat_id: chatId,
            text: text
        }

        if (text.length > 4096) {
            this.sendMessage(chatId, text.slice(0, 4096), options)
                .then(() => {
                    this.sendMessage(chatId, text.slice(4096, text.length), options)
                })
        } else {
            return this._callWithReturnType('sendMessage', Object.assign(params, options), Message)
        }
    }

    /**
     *
     * @param {number|string} chatId
     * @param {number} fromChatId
     * @param {number} messageId
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    forwardMessage(chatId, fromChatId, messageId, options) {
        const params = {
            chat_id: chatId,
            from_chat_id: fromChatId,
            message_id: messageId
        }

        return this._callWithReturnType('forwardMessage', Object.assign(params, options), Message)
    }

    /**
     * 
     * @param {number|string} chatId
     * @param {InputFile|Object} photo
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendPhoto(chatId, photo, options) {
        return this._callWithInputFile(
            'sendPhoto',
            photo,
            'photo',
            Object.assign(
                { chat_id: chatId },
                options
            )
        )
    }

    /**
     *
     * @param {number|string} chatId
     * @param {InputFile|Object} audio
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendAudio(chatId, audio, options) {
        return this._callWithInputFile(
            'sendAudio',
            audio,
            'audio',
            Object.assign(
                { chat_id: chatId },
                options
            )
        )
    }

    /**
     *
     * @param {number|string} chatId
     * @param {InputFile|Object} document
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendDocument(chatId, document, options) {
        return this._callWithInputFile(
            'sendDocument',
            document,
            'document',
            Object.assign(
                { chat_id: chatId },
                options
            )
        )
    }

    /**
     * 
     * @param {number|string} chatId
     * @param {InputFile|Object} sticker
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendSticker(chatId, sticker, options) {
        return this._callWithInputFile(
            'sendSticker',
            sticker,
            'sticker',
            Object.assign(
                { chat_id: chatId },
                options
            )
        )
    }

    /**
     *
     * @param {number|string} chatId
     * @param {InputFile|Object} video
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendVideo(chatId, video, options) {
        return this._callWithInputFile(
            'sendVideo',
            video,
            'video',
            Object.assign(
                { chat_id: chatId },
                options
            )
        )
    }

    /**
     *
     * @param {number|string} chatId
     * @param {InputFile|Object} voice
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendVoice(chatId, voice, options) {
        return this._callWithInputFile(
            'sendVoice',
            voice,
            'voice',
            Object.assign(
                { chat_id: chatId },
                options
            )
        )
    }

    /**
     *
     * @param {number|string} chatId
     * @param {number} latitude
     * @param {number} longitude
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendLocation(chatId, latitude, longitude, options) {
        const params = {
            chat_id: chatId,
            latitude: latitude,
            longitude: longitude
        }
        
        return this._callWithReturnType('sendLocation', Object.assign(params, options), Message)
    }

    /**
     *
     * @param {number|string} chatId
     * @param {number} latitude
     * @param {number} longitude
     * @param {string} title
     * @param {string}address
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendVenue(chatId, latitude, longitude, title, address, options) {
        const params = {
            chat_id: chatId,
            latitude: latitude,
            longitude: longitude,
            title: title,
            address: address
        }

        return this._callWithReturnType('sendVenue', Object.assign(params, options), Message)
    }

    /**
     *
     * @param {number|string} chatId
     * @param {string} phoneNumber
     * @param {string} firstName
     * @param {Object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendContact(chatId, phoneNumber, firstName, options) {
        const params = {
            chat_id: chatId,
            phone_number: phoneNumber,
            first_name: firstName
        }

        return this._callWithReturnType('sendContact', Object.assign(params, options), Message)
    }

    /**
     *
     * @param {number|string} chatId
     * @param {string} action
     * @returns {Promise&lt;Object>}
     */
    sendChatAction(chatId, action) {
        return this.call('sendChatAction', {
            chat_id: chatId,
            action: action
        })
    }

    /**
     *
     * @param {number} userId
     * @param {number} offset
     * @param {number} limit
     * @returns {Promise&lt;UserProfilePhotos>}
     */
    getUserProfilePhotos(userId, offset, limit) {
        return this._callWithReturnType('getUserProfilePhotos', {
            user_id: userId,
            ofsset: offset,
            limit: limit
        }, UserProfilePhotos)
    }

    /**
     *
     * @param {number} fileId
     * @returns {Promise&lt;File>}
     */
    getFile(fileId) {
        return this._callWithReturnType('getFile', { file_id: fileId }, File)
    }

    /**
     *
     * @param {number|string} chatId
     * @param {number} userId
     * @returns {Promise&lt;boolean>}
     */
    kickChatMember(chatId, userId) {
        const params = {
            chat_id: chatId,
            user_id: userId
        }

        return this.call('kickChatMember', params)
            .then(r => r.result)
    }

    /**
     *
     * @param {number|string} chatId
     * @returns {Promise&lt;boolean>}
     */
    leaveChat(chatId) {
        return this.call('leaveChat', { chat_id: chatId })
            .then(r => r.result)
    }

    /**
     *
     * @param {number|string} chatId
     * @param {number} userId
     * @returns {Promise&lt;boolean>}
     */
    unbanChatMember(chatId, userId) {
        const params = {
            chat_id: chatId,
            user_id: userId
        }

        return this.call('unbanChatMember', params)
            .then(r => r.result)
    }

    /**
     *
     * @param {number|string} chatId
     * @returns {Promise&lt;Chat>}
     */
    getChat(chatId) {
        return this._callWithReturnType('getChat', { chat_id: chatId }, Chat)
    }

    /**
     *
     * @param {number|string} chatId
     * @returns {Promise&lt;ChatMember[]>}
     */
    getChatAdministrators(chatId) {
        return this.call('getChatAdministrators', { chat_id: chatId })
            .then(r => r.result.map(m => ChatMember.deserialize(m)))
    }

    /**
     *
     * @param {number|string} chatId
     * @returns {Promise&lt;number>}
     */
    getChatMembersCount(chatId) {
        return this.call('getChatMembersCount', { chat_id: chatId })
            .then(r => r.result)
    }

    /**
     *
     * @param {number|string} chatId
     * @param {number} userId
     * @returns {Promise&lt;ChatMember>}
     */
    getChatMember(chatId, userId) {
        const params = {
            chat_id: chatId,
            user_id: userId
        }

        return this._callWithReturnType('getChatMember', params, ChatMember)
    }

    /**
     *
     * @param {string} callbackQueryId
     * @param {Object} [options]
     * @returns {Promise&lt;boolean>}
     */
    answerCallbackQuery(callbackQueryId, options) {
        const params = {
            callback_query_id: callbackQueryId
        }

        return this.call('answerCallbackQuery', Object.assign(params, options))
            .then(r => r.result)
    }

    /**
     *
     * @param {string} text
     * @param {Object} options
     * @returns {Promise&lt;boolean|Message>}
     */
    editMessageText(text, options) {
        const params = {
            text: text
        }

        return this.call('editMessageText', Object.assign(params, options))
            .then(r => typeof r.result == 'boolean' ? r.require : Message.deserialize(r.result) )
    }

    /**
     *
     * @param {Object} options
     * @returns {Promise&lt;boolean|Message>}
     */
    editMessageCaption(options) {
        return this.call('editMessageCaption', options)
            .then(r => typeof r.result == 'boolean' ? r.require : Message.deserialize(r.result))
    }

    /**
     *
     * @param {Object} options
     * @returns {Promise&lt;boolean|Message>}
     */
    editMessageReplyMarkup(options) {
        return this.call('editMessageReplyMarkup', options)
            .then(r => typeof r.result == 'boolean' ? r.require : Message.deserialize(r.result))
    }

    /**
     *
     * @param {string} inlineQueryId
     * @param {InlineQueryResult[]} results
     * @param {Object} [options]
     * @returns {Promise&lt;boolean>}
     */
    answerInlineQuery(inlineQueryId, results, options) {
        const params = {
            inline_query_id: inlineQueryId,
            results: JSON.stringify(results)
        }

        return this.call('answerInlineQuery', Object.assign(params, options))
            .then(r => r.result)
    }

    /**
     * @param {number|string} chatId
     * @param {string} gameShortName
     * @param {object} [options]
     * @returns {Promise&lt;Message>}
     */
    sendGame(chatId, gameShortName, options) {
        const params = {
            chat_id: chatId,
            game_short_name: gameShortName
        }

        return this._callWithReturnType('sendGame', Object.assign(params, options), Message)
    }

    /**
     * @param {number} userId
     * @param {number} score
     * @param {Object} [options]
     * @returns {Promise&lt;boolean|Message>}
     */
    setGameScore(userId, score, options) {
        const params = {
            chat_id: chatId,
            score: score
        }

        return this.call('setGameScore', Object.assign(params, options))
            .then(r => typeof r.result == 'boolean' ? r.require : Message.deserialize(r.result))
    }

    getGameHighScores(userId, options) {
        return this.call('getGameHighScores', Object.assign({ user_id: userId }, options))
            .then(r => r.result.map(m => ChatMember.deserialize(m)))
    }
}

module.exports = TelegramApi</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Animation.html">Animation</a></li><li><a href="Audio.html">Audio</a></li><li><a href="BaseLogger.html">BaseLogger</a></li><li><a href="BaseScopeExtension.html">BaseScopeExtension</a></li><li><a href="BaseStorage.html">BaseStorage</a></li><li><a href="BaseUpdateFetcher.html">BaseUpdateFetcher</a></li><li><a href="BaseUpdateProcessor.html">BaseUpdateProcessor</a></li><li><a href="CallbackQuery.html">CallbackQuery</a></li><li><a href="CallbackQueue.html">CallbackQueue</a></li><li><a href="Chat.html">Chat</a></li><li><a href="ChatMember.html">ChatMember</a></li><li><a href="ChosenInlineResult.html">ChosenInlineResult</a></li><li><a href="ConsoleLogger.html">ConsoleLogger</a></li><li><a href="Contact.html">Contact</a></li><li><a href="CustomFilterCommand.html">CustomFilterCommand</a></li><li><a href="Document.html">Document</a></li><li><a href="File.html">File</a></li><li><a href="ForceReply.html">ForceReply</a></li><li><a href="Game.html">Game</a></li><li><a href="GameHighScore.html">GameHighScore</a></li><li><a href="GetMessage.html">GetMessage</a></li><li><a href="InlineKeyboardButton.html">InlineKeyboardButton</a></li><li><a href="InlineKeyboardMarkup.html">InlineKeyboardMarkup</a></li><li><a href="InlineQuery.html">InlineQuery</a></li><li><a href="InlineQueryResultArticle.html">InlineQueryResultArticle</a></li><li><a href="InlineQueryResultAudio.html">InlineQueryResultAudio</a></li><li><a href="InlineQueryResultCachedAudio.html">InlineQueryResultCachedAudio</a></li><li><a href="InlineQueryResultCachedDocument.html">InlineQueryResultCachedDocument</a></li><li><a href="InlineQueryResultCachedGif.html">InlineQueryResultCachedGif</a></li><li><a href="InlineQueryResultCachedMpeg4Gif.html">InlineQueryResultCachedMpeg4Gif</a></li><li><a href="InlineQueryResultCachedPhoto.html">InlineQueryResultCachedPhoto</a></li><li><a href="InlineQueryResultCachedSticker.html">InlineQueryResultCachedSticker</a></li><li><a href="InlineQueryResultCachedVideo.html">InlineQueryResultCachedVideo</a></li><li><a href="InlineQueryResultCachedVoice.html">InlineQueryResultCachedVoice</a></li><li><a href="InlineQueryResultContact.html">InlineQueryResultContact</a></li><li><a href="InlineQueryResultDocument.html">InlineQueryResultDocument</a></li><li><a href="InlineQueryResultGame.html">InlineQueryResultGame</a></li><li><a href="InlineQueryResultGif.html">InlineQueryResultGif</a></li><li><a href="InlineQueryResultLocation.html">InlineQueryResultLocation</a></li><li><a href="InlineQueryResultMpeg4Gif.html">InlineQueryResultMpeg4Gif</a></li><li><a href="InlineQueryResultPhoto.html">InlineQueryResultPhoto</a></li><li><a href="InlineQueryResultVenue.html">InlineQueryResultVenue</a></li><li><a href="InlineQueryResultVideo.html">InlineQueryResultVideo</a></li><li><a href="InlineQueryResultVoice.html">InlineQueryResultVoice</a></li><li><a href="InlineQueryUpdateProcessor.html">InlineQueryUpdateProcessor</a></li><li><a href="InlineScope.html">InlineScope</a></li><li><a href="InMemoryStorage.html">InMemoryStorage</a></li><li><a href="InputContactMessageContent.html">InputContactMessageContent</a></li><li><a href="InputFile.html">InputFile</a></li><li><a href="InputLocationMessageContent.html">InputLocationMessageContent</a></li><li><a href="InputTextMessageContent.html">InputTextMessageContent</a></li><li><a href="InputVenueMessageContent.html">InputVenueMessageContent</a></li><li><a href="Ivan.html">Ivan</a></li><li><a href="KeyboardButton.html">KeyboardButton</a></li><li><a href="Localization.html">Localization</a></li><li><a href="Location.html">Location</a></li><li><a href="LongPoolingUpdateFetcher.html">LongPoolingUpdateFetcher</a></li><li><a href="Message.html">Message</a></li><li><a href="MessageEntity.html">MessageEntity</a></li><li><a href="MessageUpdateProcessor.html">MessageUpdateProcessor</a></li><li><a href="PhotoSize.html">PhotoSize</a></li><li><a href="RegexpCommand.html">RegexpCommand</a></li><li><a href="RemoveMessage.html">RemoveMessage</a></li><li><a href="ReplyKeyboardHide.html">ReplyKeyboardHide</a></li><li><a href="ReplyKeyboardMarkup.html">ReplyKeyboardMarkup</a></li><li><a href="ReplyKeyboardRemove.html">ReplyKeyboardRemove</a></li><li><a href="ResponseMessage.html">ResponseMessage</a></li><li><a href="ResponseParameters.html">ResponseParameters</a></li><li><a href="Scope.html">Scope</a></li><li><a href="SetMessage.html">SetMessage</a></li><li><a href="SharedStorage.html">SharedStorage</a></li><li><a href="Sticker.html">Sticker</a></li><li><a href="Telegram.html">Telegram</a></li><li><a href="TelegramApi.html">TelegramApi</a></li><li><a href="TelegramApiError.html">TelegramApiError</a></li><li><a href="TelegramApiRequest.html">TelegramApiRequest</a></li><li><a href="TelegramBaseCallbackQueryController.html">TelegramBaseCallbackQueryController</a></li><li><a href="TelegramBaseController.html">TelegramBaseController</a></li><li><a href="TelegramBaseInlineQueryController.html">TelegramBaseInlineQueryController</a></li><li><a href="TelegramDataSource.html">TelegramDataSource</a></li><li><a href="TelegramRoute.html">TelegramRoute</a></li><li><a href="TelegramSession.html">TelegramSession</a></li><li><a href="TelegramSessionStorage.html">TelegramSessionStorage</a></li><li><a href="TextCommand.html">TextCommand</a></li><li><a href="Update.html">Update</a></li><li><a href="UpdateProcessorsManager.html">UpdateProcessorsManager</a></li><li><a href="User.html">User</a></li><li><a href="UserProfilePhotos.html">UserProfilePhotos</a></li><li><a href="Venue.html">Venue</a></li><li><a href="Video.html">Video</a></li><li><a href="Voice.html">Voice</a></li><li><a href="WebAdmin.html">WebAdmin</a></li><li><a href="WebhookInfo.html">WebhookInfo</a></li><li><a href="WebhookUpdateFetcher.html">WebhookUpdateFetcher</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Sep 04 2018 15:09:37 GMT+0300 (GMT+03:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
